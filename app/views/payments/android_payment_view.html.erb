<div class="container">
  <div class="row m-t-20">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
      <h3 class="color-pink m-b-10">Please confirm your information</h3>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6 m-t-20 m-b-10">
      <span class="color-gray"><%= @temp_user.registration_plan %> Plan</span>
    </div>
    <div class="col-xs-6 m-t-20 m-b-10">
      <span class="color-pink pull-right" id="change_plan">Change plan</span>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-6 m-b-10 color-gray">
      <%= price_rate_of_plan(@temp_user.registration_plan) %>
    </div>
    <div class="col-xs-6 m-b-10 color-gray">
      <span class="pull-right"><%= Time.now.strftime("%d/%b/%Y") %>
      </span>
    </div>
    <hr>
  </div>
  <div class="row">
    <div class="col-xs-12 m-t-20 color-gray">
      <%= @temp_user.email %>
    </div>
  </div>
  <%= form_tag( "/do_payment_android/#{@temp_user.id}", id: "payment_method") do %>
    <div class="row">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 m-t-20">
        <h3 class="color-pink m-b-30">Payment Method</h3>
      </div>
    </div>
    <div class="row">
      <div class="form-radio">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-4">
          <div class="radio">
            <input id="payment_type_PayPal" type="radio" checked="" value="Paypal" name="payment_type"><i class="helper"></i>
            <label for="payment_type_PayPal">Paypal
            </label>
          </div>
        </div>
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-6">
          <div class="radio">
            <input id="payment_type_Card" type="radio" value="Card" name="payment_type"><i class="helper"></i>
            <label for="payment_type_Card">Card
            </label>
          </div>
        </div>
      </div>
    </div>
    <div style="display: none;" id="card_info">
      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 ">
          <div class="form-group">
            <%= text_field_tag :card_number, nil,class: "form-control", "data-stripe"=> "number", required: true%>
              <label class="control-label" for="card_number" style="left:0;">Card Number</label>
              <i class="bar"></i>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-3">
          <div class="form-group">
            <%= select_tag :expiration_month, options_for_select(1..12), "data-stripe"=> "exp-month" %>
              <label class="control-label" for="select">Month</label><i class="bar"></i>
          </div>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-3 p-0">
          <div class="form-group">
            <%= select_tag :expiration_year, options_for_select(Time.now.year..Time.now.year+20), "data-stripe"=> "exp-year" %>
              <label class="control-label" for="select">Year</label><i class="bar"></i>
          </div>
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 form-group card-cvv m-t-16">
          <%= text_field_tag :card_CVC, nil,class: "form-control",:maxlength=> 4, "data-stripe" => "cvv", required: true %>
            <i class="bar"></i>
            <label class="control-label" for="card_CVC">Card CVV</label>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <label class="payment-errors error"></label>
      </div>
    </div>
    <div class="row">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="button-container">
          <button class="button" type="button" id="btnSubmit"><span>Subscribe</span>
          </button>
          <%#= submit_tag "Get Started",class: "button" %>
        </div>
      </div>
    </div>
   <% end %>
</div>
<div class="backdrop"></div>
<div class="la-ball-clip-rotate-multiple app-loader">
  <div></div>
  <div></div>
</div>

<script type="text/javascript">

  $(document).on("click", "#payment_method input[type='radio']",
    function(e) {
      if ($("#payment_type_Card:checked").val() == "Card") {
        $("#card_info").show();
        $("#card_info :input").removeAttr("disabled");
        check_stripe = 1;
      } else {
        $("#card_info").hide();
        $("#card_info :input").attr("disabled", true);
        // $(".payment-errors").text('');
        check_stripe = 0;
      }
    }
  );
  var $form = $('#payment_method');
  Stripe.setPublishableKey($('meta[name="stripe-key"]').attr('content'));
  $('#btnSubmit').click(function(event) {
    console.log("button click")
    if ($("#payment_method").valid()) {
      var user_hash = {
        user_name: '<%= @temp_user.name %>',
        email: '<%= @temp_user.email %>',
        registration_plan: '<%= @temp_user.registration_plan %>',
        payment_type: $("input[name='payment_type']:checked").val()
      }
      fbq('trackCustom', 'AndroidSubscription', user_hash);
      $(".app-loader").show();
      $(".backdrop").show();
      if (check_stripe == 1) {
        Stripe.card.createToken($form, stripeResponseHandler);
        // Prevent the form from being submitted:
        console.log("in side if")
        return false;
      }
      $('#payment_method')[0].submit(function(event) {
        /* Act on the event */
        console.log("form submit")
        $form.find('#btnSubmit').prop('disabled', true);
        // Request a token from Stripe:
      });
    }
  });
  $('#change_plan').click(function(event) {
    /* Act on the event */
    console.log("clicked")
    app.Click();
  });
  var check_stripe;

  function stripeResponseHandler(status, response) {
    console.log("in side")
    if (response.error) { // Problem!
      // Show the errors on the form:
      $form.find('.payment-errors').text(response.error.message).show();
      $form.find('#btnSubmit').prop('disabled', false); // Re-enable submission
      $(".app-loader").hide();
      $(".backdrop").hide();
    } else { // Token was created!
      // Get the token ID:
      var token = response.id;

      // Insert the token ID into the form so it gets submitted to the server:
      $form.append($('<input type="hidden" name="stripeToken" id="token">').val(token));

      // Submit the form:
      check_stripe = 0;
      $form.find('#submit').prop('disabled', false); // Re-enable submission
      $('#submit').click();
      $('#payment_method')[0].submit()
    }
  };
  $(document).ready(function() {
    $("#payment_method").validate({
      rules: {
        "card_number": {
          required: true,
          creditcard: true,
          minlength: 13,
          maxlength: 16
        },
        "card_CVC": {
          required: true,
          minlength: 3,
          maxlength: 3
        }
      },
      messages: {
        "card_number": {
          required: "Enter your credit card number."
        },
        "card_CVC": {
          required: "Enter card CVC."
        }
      }
    });

  });
</script>
